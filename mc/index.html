<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="departmentName + ' ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒãƒ¼ã‚¿ãƒ«'"></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'portal-primary': '#4f46e5', // Indigo-600
                        'portal-bg': '#f3f4f6', // Gray-100
                    }
                }
            }
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body class="bg-portal-bg min-h-screen">

    <div x-data="portfolioPortal()" x-init="fetchData()" class="relative">

        <header class="bg-white shadow-md sticky top-0 z-20">
            <div
                class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-portal-primary leading-tight">
                    <span x-text="departmentName"></span>
                    <span class="inline-block">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒãƒ¼ã‚¿ãƒ«</span>
                </h1>

                <div class="mt-4 sm:mt-0 flex flex-wrap gap-2">
                    <input type="text" x-model.debounce.300ms="searchTerm" placeholder="åå‰/ä½œå“åã§æ¤œç´¢..."
                        class="border border-gray-300 rounded-lg p-2 text-sm w-full sm:w-auto">

                    <select x-model="selectedTag" class="border border-gray-300 rounded-lg p-2 text-sm">
                        <option value="All">ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿ (å…¨ã¦)</option>
                        <template x-for="tag in availableTags" :key="tag">
                            <option :value="tag" x-text="tag"></option>
                        </template>
                    </select>

                    <select x-model="sortKey" class="border border-gray-300 rounded-lg p-2 text-sm">
                        <option value="updated_at" selected>ã‚½ãƒ¼ãƒˆï¼šæ–°ç€é †</option>
                        <option value="name">ã‚½ãƒ¼ãƒˆï¼šåå‰é †</option>
                        <option value="year">ã‚½ãƒ¼ãƒˆï¼šå­¦å¹´é †</option>
                    </select>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-gray-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap gap-3 items-center">
                    <span class="text-sm font-semibold text-gray-700">å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>

                    <div class="flex space-x-2">

                        <button @click="activeYearFilter = 'All'"
                            class="px-4 py-1.5 rounded-full text-sm font-medium transition duration-150"
                            :class="activeYearFilter === 'All' ? 'bg-portal-primary text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-portal-primary/20'">
                            å…¨ä½“
                        </button>

                        <template x-for="grade in grades" :key="grade.year">
                            <button @click="activeYearFilter = grade.year"
                                class="px-4 py-1.5 rounded-full text-sm font-medium transition duration-150"
                                :class="activeYearFilter === grade.year ? 'bg-portal-primary text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-portal-primary/20'">
                                <span x-text="grade.label"></span> (<span x-text="grade.gradYear % 100"></span>å¹´å’)
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div x-show="isLoading" class="text-center text-lg text-gray-500 py-12">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
            <div x-show="!isLoading && combinedFilteredPortfolios.length === 0"
                class="text-center text-lg text-gray-500 py-12">
                è©²å½“ã™ã‚‹ä½œå“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
            </div>

            <div x-show="!isLoading">
                <template x-for="grade in grades" :key="grade.year">
                    <section class="mb-12" x-show="shouldShowSection(grade.year)">

                        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-portal-primary/50 pb-2">
                            <span x-text="grade.label"></span>
                            <span class="text-xl text-gray-500 font-normal ml-2">
                                (<span x-text="grade.gradYear % 100"></span>å¹´å’)
                            </span>
                        </h2>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

                            <template x-for="portfolio in filteredPortfoliosByGrade(grade.year)" :key="portfolio.name">
                                <a :href="portfolio.link_type === 'Portfolio' || portfolio.link_type === 'Site' ? portfolio.url : '#'"
                                    :target="portfolio.link_type === 'Portfolio' || portfolio.link_type === 'Site' ? '_blank' : '_self'"
                                    @click.prevent="handleCardClick(portfolio)" x-data="{ hovered: false }"
                                    @mouseenter="hovered = true" @mouseleave="hovered = false"
                                    class="block group rounded-xl overflow-hidden shadow-lg transition duration-300 ease-in-out bg-white transform cursor-pointer"
                                    :class="hovered ? 'scale-[1.03] shadow-2xl ring-2 ring-portal-primary' : 'scale-100 shadow-xl'">

                                    <div class="aspect-video overflow-hidden relative">
                                        <img loading="lazy" :src="portfolio.thumbnail_url"
                                            :alt="'ä½œå“ã‚µãƒ ãƒã‚¤ãƒ« ' + portfolio.name"
                                            @error="this.onerror=null; this.src='https://via.placeholder.com/640x360?text=Image+Load+Error'"
                                            class="w-full h-full object-cover transition duration-300 ease-in-out group-hover:opacity-85">

                                    </div>

                                    <div class="p-4 relative">

                                        <div
                                            class="absolute top-4 right-4 bg-portal-primary text-white p-1 rounded-full shadow-lg z-10">
                                            <span x-show="portfolio.link_type === 'Video'">â–¶ï¸</span>
                                            <span x-show="portfolio.link_type === 'PDF'">ğŸ“„</span>
                                            <span
                                                x-show="portfolio.link_type === 'Portfolio' || portfolio.link_type === 'Site'">ğŸŒ</span>
                                        </div>

                                        <h3
                                            class="text-xl font-extrabold text-gray-900 group-hover:text-portal-primary transition duration-150 truncate pr-10">
                                            <span class="text-base font-semibold mr-1"
                                                x-text="portfolio.student_id"></span>
                                            <span x-text="portfolio.student"></span>
                                        </h3>

                                        <p class="text-sm text-gray-600 mt-1 line-clamp-2"
                                            x-text="portfolio.note || 'ä½œå“æ¦‚è¦ã¯ã‚ã‚Šã¾ã›ã‚“'"></p>

                                        <div class="mt-2 flex flex-wrap gap-2 text-xs">
                                            <template
                                                x-for="tag in portfolio.tags.split(',').map(t => t.trim()).filter(t => t)"
                                                :key="tag">
                                                <span
                                                    class="bg-portal-primary/10 text-portal-primary font-medium px-2 py-0.5 rounded-full"
                                                    x-text="tag"></span>
                                            </template>
                                        </div>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </section>
                </template>
            </div>

        </main>

        <footer class="mt-12 py-4 text-center text-sm text-gray-500 border-t border-gray-200">
            &copy; 2025 ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–å­¦ç§‘ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒãƒ¼ã‚¿ãƒ«. All rights reserved.
        </footer>

        <div x-cloak x-show="isModalOpen"
            class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
            @click.self="closeModal()">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-full max-h-[90vh] relative">

                <button @click="closeModal()"
                    class="absolute top-0 right-0 m-3 text-gray-700 hover:text-red-600 z-10 p-2 bg-white rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>

                <div class="w-full h-full p-6">
                    <h3 class="text-lg font-semibold mb-2" x-text="currentMediaType === 'Video' ? 'å‹•ç”»å†ç”Ÿ' : 'PDFãƒ“ãƒ¥ãƒ¼ã‚¢'">
                    </h3>

                    <iframe :src="currentMediaUrl"
                        class="w-full h-[calc(100%-40px)] border-2 border-gray-300 rounded-md"
                        allow="autoplay; encrypted-media" allowfullscreen>
                    </iframe>

                    <p class="text-xs text-gray-500 mt-1">â€» ãƒªãƒ³ã‚¯å…ƒã®è¨­å®šã«ã‚ˆã‚Šè¡¨ç¤ºã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™</p>
                </div>

            </div>
        </div>

    </div>

    <script>
        // =======================================================
        // ğŸš¨ ç®¡ç†è€…è¨­å®šã‚¨ãƒªã‚¢ ğŸš¨ (ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã‚’ç·¨é›†ã—ã¦ãã ã•ã„)
        // =======================================================

        // 0. å­¦ç§‘åã‚’è¨­å®šã—ã¦ãã ã•ã„
        const DEPARTMENT_NAME = 'ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–å­¦ç§‘';

        // 1. Google Apps Script ã®å…¬é–‹ URL ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzgegi8TtZSaxwtWBYWuakT0NtzFvJU1AZWbrAqTtYq4zacs7NmzyoH0SQDb3Yt4Syq/exec';

        // 2. å­¦å¹´ã¨å’æ¥­å¹´åº¦ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ãã ã•ã„
        const GRADE_MAPPING = [
            { year: 3, label: '3å¹´ç”Ÿ', gradYear: 2027 },
            { year: 2, label: '2å¹´ç”Ÿ', gradYear: 2028 },
            { year: 1, label: '1å¹´ç”Ÿ', gradYear: 2029 },
        ];

        // =======================================================
        // ğŸš¨ ç®¡ç†è€…è¨­å®šã‚¨ãƒªã‚¢ çµ‚äº† ğŸš¨ (ã“ã“ã‹ã‚‰ä¸‹ã¯åŸå‰‡å¤‰æ›´ä¸è¦ã§ã™)
        // =======================================================

        document.addEventListener('alpine:init', () => {
            Alpine.data('portfolioPortal', () => ({

                // çŠ¶æ…‹ç®¡ç†
                portfolios: [], // å…ƒãƒ‡ãƒ¼ã‚¿
                isLoading: true,

                departmentName: DEPARTMENT_NAME,

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼/ã‚½ãƒ¼ãƒˆã®çŠ¶æ…‹
                searchTerm: '',
                selectedTag: 'All',
                activeYearFilter: 'All', // 'All' ã¯æ–‡å­—åˆ—
                sortKey: 'updated_at',

                // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹
                isModalOpen: false,
                currentMediaUrl: '',
                currentMediaType: '', // 'Video' or 'PDF'

                grades: GRADE_MAPPING,

                // =======================================================
                // 1. ãƒ‡ãƒ¼ã‚¿å–å¾—
                // =======================================================
                async fetchData() {
                    this.isLoading = true;
                    try {
                        const response = await fetch(GAS_WEB_APP_URL);
                        if (!response.ok) {
                            throw new Error('GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                        const data = await response.json();

                        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨åˆæœŸåŒ–
                        this.portfolios = data.map(p => ({
                            ...p,
                            // yearã‚’æ•°å€¤ã«å¤‰æ› (GASå´ã§æ—¢ã«å¤‰æ›æ¸ˆã¿ã ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã§ã‚‚å¿µã®ãŸã‚å®Ÿè¡Œ)
                            year: parseInt(p.year) || 0,
                            // updated_atã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯æ¯”è¼ƒå¯èƒ½ãªå€¤ã«å¤‰æ›
                            updated_at: p.updated_at ? new Date(p.updated_at).getTime() : 0,
                            student_id: p.student_id || '',
                            tags: p.tags || '',
                            thumbnail_url: p.thumbnail_url || 'https://via.placeholder.com/640x360?text=No+Image',
                        }));

                    } catch (error) {
                        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                        this.portfolios = [];
                    } finally {
                        this.isLoading = false;
                    }
                },

                // =======================================================
                // 2. è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ / ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
                // =======================================================

                get availableTags() {
                    if (this.portfolios.length === 0) return [];
                    const allTags = new Set();
                    this.portfolios.forEach(p => {
                        if (p.tags) {
                            p.tags.split(',').map(t => t.trim()).filter(t => t).forEach(tag => allTags.add(tag));
                        }
                    });
                    return Array.from(allTags).sort();
                },

                // æ¤œç´¢ã€ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã€ã‚½ãƒ¼ãƒˆã‚’çµ±åˆã—ãŸãƒªã‚¹ãƒˆ
                get combinedFilteredPortfolios() {
                    let filtered = this.portfolios;

                    // 1. æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    if (this.searchTerm) {
                        const term = this.searchTerm.toLowerCase();
                        filtered = filtered.filter(p =>
                            p.name.toLowerCase().includes(term) ||
                            (p.student && p.student.toLowerCase().includes(term)) || // æ°åã‚‚æ¤œç´¢å¯¾è±¡ã«è¿½åŠ 
                            (p.note && p.note.toLowerCase().includes(term))
                        );
                    }

                    // 2. ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    if (this.selectedTag !== 'All') {
                        const tag = this.selectedTag;
                        filtered = filtered.filter(p =>
                            p.tags && p.tags.split(',').map(t => t.trim()).includes(tag)
                        );
                    }

                    // 3. ã‚½ãƒ¼ãƒˆ
                    const key = this.sortKey;
                    filtered.sort((a, b) => {
                        // æ–°ç€é † (updated_at) ã¯é™é † (æ–°ã—ã„ã‚‚ã®ãŒå…ˆ)
                        if (key === 'updated_at') {
                            return b[key] - a[key];
                        }
                        // åå‰é †ã¯æ˜‡é † (æ–‡å­—åˆ—æ¯”è¼ƒ)
                        else if (key === 'name') {
                            return a[key].localeCompare(b[key], 'ja', { sensitivity: 'base' });
                        }
                        // å­¦å¹´é †ã¯é™é † (å­¦å¹´ãŒè‹¥ã„é †ã€ã¤ã¾ã‚Š year ãŒå¤§ãã„é †)
                        else if (key === 'year') {
                            return b[key] - a[key];
                        }
                        return 0;
                    });

                    return filtered;
                },

                // æŒ‡å®šã•ã‚ŒãŸå­¦å¹´ã®ä½œå“ã®ã¿ã‚’æŠ½å‡º (ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨)
                filteredPortfoliosByGrade(year) {
                    return this.combinedFilteredPortfolios.filter(p => p.year === year);
                },

                // ğŸš¨ ä¿®æ­£ç‚¹2: activeYearFilterã‚’æ•°å€¤ã«å¤‰æ›ã—ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€3å¹´ç”ŸãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã‚’è§£æ¶ˆ
                shouldShowSection(year) {
                    if (this.activeYearFilter === 'All') {
                        // 'All'ã®å ´åˆã€è©²å½“å­¦å¹´ã®ä½œå“ãŒã‚ã‚‹ãªã‚‰è¡¨ç¤º
                        return this.filteredPortfoliosByGrade(year).length > 0;
                    }
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæ•°å€¤ï¼ˆä¾‹: 3ï¼‰ã®å ´åˆã€yearã¨å³å¯†ã«æ¯”è¼ƒ
                    return parseInt(this.activeYearFilter) === year;
                },

                // =======================================================
                // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«/ãƒªãƒ³ã‚¯åˆ¶å¾¡
                // =======================================================

                handleCardClick(portfolio) {
                    if (portfolio.link_type === 'Video' || portfolio.link_type === 'PDF') {
                        this.openModal(portfolio.url, portfolio.link_type);
                    } else {
                        window.open(portfolio.url, '_blank');
                    }
                },

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                openModal(url, type) {
                    let srcUrl = url;
                    this.currentMediaType = type;

                    // Video (YouTube) ã®URLã‚’åŸ‹ã‚è¾¼ã¿å½¢å¼ã«å¼·åˆ¶å¤‰æ›
                    if (type === 'Video') {
                        if (url.includes('youtube.com/watch?v=')) {
                            srcUrl = url.replace('watch?v=', 'embed/');
                        }
                        else if (url.includes('youtu.be/')) {
                            srcUrl = url.replace('youtu.be/', 'youtube.com/embed/');
                        }
                        // è¿½åŠ : ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã®è‡ªå‹•å†ç”Ÿã‚„UIéè¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                        if (!srcUrl.includes('?')) {
                            srcUrl += '?';
                        } else {
                            srcUrl += '&';
                        }
                        srcUrl += 'autoplay=1&rel=0';
                    }

                    // PDFã®å ´åˆã€åŸ‹ã‚è¾¼ã¿ã«é©ã—ãŸå½¢å¼ã«å¤‰æ›ã‚’è©¦ã¿ã‚‹ï¼ˆGoogle Driveã®å ´åˆï¼‰
                    else if (type === 'PDF' && url.includes('drive.google.com')) {
                        // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’åŸ‹ã‚è¾¼ã¿ãƒ“ãƒ¥ãƒ¼ã‚¢å½¢å¼ã«å¤‰æ›
                        srcUrl = url.replace('/view', '/preview');
                    }

                    this.currentMediaUrl = srcUrl;
                    this.isModalOpen = true;
                    document.body.style.overflow = 'hidden';
                },

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeModal() {
                    this.isModalOpen = false;
                    this.currentMediaUrl = '';
                    this.currentMediaType = '';
                    document.body.style.overflow = 'auto';
                }

            }));
        });
    </script>

</body>

</html>